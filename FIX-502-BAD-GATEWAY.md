# ุฑุงูููุง ุฑูุน ุฎุทุง 502 Bad Gateway

## ๐ด ูุดฺฉู

ุฎุทุง **502 Bad Gateway** ุนู:
- Nginx (reverse proxy) ููโุชูุงูุฏ ุจู ุณุฑูุฑ backend (Node.js) ูุชุตู ุดูุฏ
- ุง ุณุฑูุฑ backend ุฏุฑ ุญุงู restart ุงุณุช

## ๐ ุนูุชโูุง ุงุญุชูุงู

### 1. Container ุฏุฑ ุญุงู Restart ุงุณุช
ุงุฒ ูุงฺฏโูุง ูุดุฎุต ุงุณุช ฺฉู ุณุฑูุฑ ุฏู ุจุงุฑ start ุดุฏู:
```
> node server.js
๐ Starting server...
โ Server ready on http://0.0.0.0:3001
๐ Process ID: 19
```

ุงู ุนู container restart ูโุดูุฏ ู Nginx ููโุชูุงูุฏ ุจู ุขู ูุชุตู ุดูุฏ.

### 2. Probeโูุง ูููุฒ ุฑู ูพูุฑุช 3000 ูุณุชูุฏ
ุงฺฏุฑ probeโูุง ูููุฒ ุฑู 3000 ุจุงุดูุฏุ container restart ูโุดูุฏ.

### 3. ูุดฺฉู RAM
ูุตุฑู RAM 99% ูโุชูุงูุฏ ุจุงุนุซ restart ุดูุฏ.

---

## โ ุฑุงูโุญูโูุง

### ฺฏุงู 1: ุจุฑุฑุณ ู ุชุบุฑ Probeโูุง (ุงูููุช ุงูู)

1. **ุจู ูพูู Runflare ุจุฑู**
2. **ุจู ุจุฎุด "ุชุณุช ุณูุงูุช" (Health Test) ุจุฑู**
3. **Startup Probe ุฑุง ุจุฑุฑุณ ฺฉู:**
   - ุงฺฏุฑ ูพูุฑุช **3000** ุงุณุช โ ุจู **3001** ุชุบุฑ ุจุฏู
   - **ุชุงุฎุฑ ุดุฑูุน** ุฑุง ุจู **30s** ุงูุฒุงุด ุจุฏู
   - **failureThreshold** ุฑุง ุจู **10** ุงูุฒุงุด ุจุฏู

4. **Liveness Probe ุฑุง ุจุฑุฑุณ ฺฉู:**
   - ุงฺฏุฑ ูพูุฑุช **3000** ุงุณุช โ ุจู **3001** ุชุบุฑ ุจุฏู
   - **ุชุงุฎุฑ ุดุฑูุน** ุฑุง ุจู **10s** ุงูุฒุงุด ุจุฏู

5. **ุฐุฎุฑู ฺฉู ู ููุชุธุฑ ุจูุงู** (2-3 ุฏููู)

---

### ฺฏุงู 2: ุจุฑุฑุณ Environment Variables

ุฏุฑ ูพูู Runflareุ ุจู ุจุฎุด **"ุชูุธู ูุชุบุฑ ูุญุท"** ุจุฑู ู ูุทูุฆู ุดู:

```env
PORT=3001
HOST=0.0.0.0
NODE_ENV=production
```

---

### ฺฏุงู 3: ุจุฑุฑุณ ูุถุนุช Container

ุฏุฑ ูพูู Runflare:

1. **ุจู ุจุฎุด "ูุดุงูุฏู ูุงฺฏ" (View Logs) ุจุฑู**
2. **ุฏูุจุงู ุงู ูพุงูโูุง ุจฺฏุฑุฏ:**
   - `SIGTERM received` โ ุนู container kill ุดุฏู
   - `Startup probe failed` โ ุนู probe fail ุดุฏู
   - `Unhealthy` โ ุนู health check fail ุดุฏู

3. **ุงฺฏุฑ container ุฏุฑ ุญุงู restart ุงุณุช:**
   - Probeโูุง ุฑุง ุชุบุฑ ุจุฏู (ฺฏุงู 1)
   - ฺูุฏ ุฏููู ุตุจุฑ ฺฉู
   - ุฏูุจุงุฑู ุจุฑุฑุณ ฺฉู

---

### ฺฏุงู 4: ุชุณุช Health Check

ุจุนุฏ ุงุฒ ุชุบุฑ probeโูุงุ ุงู ุฏุณุชูุฑุงุช ุฑุง ุงุฒ terminal ุงุฌุฑุง ฺฉู:

```bash
# ุชุณุช health check
curl http://localhost:3001/api/health

# ุจุงุฏ ุงู ุฎุฑูุฌ ุฑุง ุจุจู:
# {"status":"ok","timestamp":"...","environment":"production",...}
```

ุงฺฏุฑ health check ฺฉุงุฑ ฺฉุฑุฏุ ุนู ุณุฑูุฑ ุฏุฑ ุญุงู ุงุฌุฑุง ุงุณุช.

---

### ฺฏุงู 5: ุจุฑุฑุณ Nginx Configuration

ุงฺฏุฑ ุจุนุฏ ุงุฒ ุชุบุฑ probeโูุง ูููุฒ 502 ูโุจู:

1. **ุฏุฑ ูพูู Runflareุ ุจู ุจุฎุด ุชูุธูุงุช Nginx ุจุฑู**
2. **ูุทูุฆู ุดู ฺฉู upstream ุจู ูพูุฑุช 3001 ุงุดุงุฑู ูโฺฉูุฏ:**
   ```nginx
   upstream backend {
       server localhost:3001;
   }
   ```

3. **ุง ุงฺฏุฑ ุงุฒ domain ุงุณุชูุงุฏู ูโฺฉู:**
   - ูุทูุฆู ุดู ฺฉู domain ุจู ุฏุฑุณุช ุชูุธู ุดุฏู ุงุณุช

---

## ๐ง ุฏุณุชูุฑุงุช ููุฏ ุจุฑุง Debug

ุงุฒ terminal ุฏุฑ ูพูู Runflare:

```bash
# 1. ุจุฑุฑุณ ุงูฺฉู ุณุฑูุฑ ุฑู 3001 ุฏุฑ ุญุงู ุงุฌุฑุง ุงุณุช
netstat -tlnp | grep 3001

# ุจุงุฏ ุจุจู:
# tcp  0  0  0.0.0.0:3001  0.0.0.0:*  LISTEN  <PID>/node

# 2. ุจุฑุฑุณ process
ps aux | grep node

# 3. ุจุฑุฑุณ environment variables
echo $PORT
echo $HOST

# 4. ุชุณุช health check
curl http://localhost:3001/api/health

# 5. ุจุฑุฑุณ ูุงฺฏโูุง ุงุฎุฑ
tail -n 50 /var/log/app.log
```

---

## ๐ ฺฺฉโูุณุช

- [ ] Startup Probe ูพูุฑุช ุฑุง ุจู 3001 ุชุบุฑ ุฏุงุฏู
- [ ] Liveness Probe ูพูุฑุช ุฑุง ุจู 3001 ุชุบุฑ ุฏุงุฏู
- [ ] ุชุงุฎุฑ ุดุฑูุน Startup Probe ุฑุง ุจู 30s ุงูุฒุงุด ุฏุงุฏู
- [ ] Environment Variable `PORT=3001` ุชูุธู ุดุฏู ุงุณุช
- [ ] 2-3 ุฏููู ุตุจุฑ ฺฉุฑุฏู ุชุง ุชุบุฑุงุช ุงุนูุงู ุดูุฏ
- [ ] Health check ุฑุง ุชุณุช ฺฉุฑุฏู (`curl http://localhost:3001/api/health`)
- [ ] ุงฺฏุฑ ูููุฒ 502 ูโุจูุ ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉุฑุฏู

---

## โ๏ธ ุงฺฏุฑ ูููุฒ ูุดฺฉู ุฏุงุฑ

1. **ูุงฺฏโูุง ฺฉุงูู ุฑุง ฺฉูพ ฺฉู** (ุงุฒ ูพูู Runflare โ ูุดุงูุฏู ูุงฺฏ)
2. **ุฎุฑูุฌ ุงู ุฏุณุชูุฑุงุช ุฑุง ุจูุฑุณุช:**
   ```bash
   netstat -tlnp | grep 3001
   ps aux | grep node
   curl http://localhost:3001/api/health
   ```
3. **ูุถุนุช probeโูุง ุฑุง ุจฺฏู** (ูพูุฑุชโูุง ุฑู 3000 ูุณุชูุฏ ุง 3001ุ)

---

## ๐ก ูฺฉุชู ููู

**502 Bad Gateway** ูุนูููุงู ุจู ุงู ูุนู ุงุณุช ฺฉู:
- ุณุฑูุฑ backend ุฏุฑ ุญุงู restart ุงุณุช (ุจู ุฎุงุทุฑ probeโูุง ุงุดุชุจุงู)
- ุง Nginx ููโุชูุงูุฏ ุจู backend ูุชุตู ุดูุฏ

**ุฑุงูโุญู ุงุตู:** ุชุบุฑ probeโูุง ุงุฒ 3000 ุจู 3001

