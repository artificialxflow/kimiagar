## TODO v4 – کیف‌پول و پنل ادمین (آپدیت آذر ۱۴۰۴)

- [x] **واریز کاربر – تبدیل به فرآیند دو مرحله‌ای (در انتظار / تایید ادمین)**
  - [x] بازبینی کامل روت `app/api/wallet/deposit/route.ts` و مستندسازی رفتار فعلی (شارژ مستقیم + `status: 'COMPLETED'`).
  - [x] تغییر منطق واریز کاربر به این شکل:
    - [x] فقط ایجاد `transaction` با نوع `DEPOSIT` و وضعیت `PENDING` برای کیف پول ریالی کاربر.
    - [x] عدم تغییر `wallet.balance` در مرحله‌ی درخواست واریز.
  - [x] اطمینان از ذخیره‌ی اطلاعات کمکی (شرح، شماره فیش، …) داخل `transaction.metadata` در صورت نیاز.

- [x] **ایجاد روت ادمین برای تأیید/رد واریزهای در انتظار**
  - [x] ایجاد روت جدید مثل `app/api/admin/wallet/deposit/confirm/route.ts` (یا نام مشابه) فقط برای ادمین‌ها.
  - [x] پیاده‌سازی منطق تأیید درون `prisma.$transaction`:
    - [x] یافتن `transaction` با `type = 'DEPOSIT'` و `status = 'PENDING'` و متعلق به همان کاربر.
    - [x] افزایش `wallet.balance` به اندازه‌ی مبلغ تراکنش روی کیف پول صحیح (معمولاً `RIAL`).
    - [x] به‌روزرسانی `transaction.status` به `COMPLETED` و ثبت اطلاعات ادمین در `metadata` (شناسه ادمین، نام کاربری، زمان تأیید، توضیح).
  - [x] پیاده‌سازی اکشن «رد واریز»:
    - [x] تغییر `transaction.status` به `FAILED` (یا `CANCELLED`) بدون دست‌کاری موجودی.
    - [x] ذخیره‌ی دلیل رد در `statusReason` و/یا `metadata`.

- [x] **به‌روزرسانی UI پنل ادمین برای مدیریت واریزهای در انتظار**
  - [x] شناسایی محل نمایش تراکنش‌ها در پنل ادمین (`UserTransactions.tsx` / `UserWalletModal.tsx` و …).
  - [x] اضافه‌کردن ستون «عملیات» برای ردیف‌های با `type = 'DEPOSIT'` و `status = 'PENDING'`:
    - [x] دکمه «تأیید واریز» که روت تأیید ادمین را صدا بزند و بعد از موفقیت، لیست را رفرش کند.
    - [x] دکمه «رد واریز» با گرفتن دلیل رد و صدا زدن روت رد.
  - [x] نمایش واضح وضعیت تراکنش (برچسب‌های «در انتظار»، «تکمیل‌شده»، «رد شده»، …) برای هم‌خوانی با اسکرین‌شات‌های کاربر.

- [ ] **بررسی و تفکیک شارژ دستی ادمین از واریز کاربر**
  - [x] بازبینی روت `app/api/admin/wallet/charge/route.ts` و تأیید این‌که فقط برای «شارژ دستی» توسط ادمین استفاده می‌شود.
  - [x] تصمیم‌گیری:
    - [x] شارژ دستی توسط ادمین (به‌عنوان عملیات داخلی) فعلاً به‌صورت شارژ فوری باقی بماند و منطق فعلی (افزایش مستقیم موجودی + `COMPLETED`) حفظ شود.

- [x] **مشکل خروج ناگهانی از پنل ادمین / خالی‌شدن لیست کاربران**
  - [x] بررسی و تنظیم طول عمر `accessToken`:
    - [x] تغییر `expiresIn` در `app/lib/jwt.ts` (از `15m` به `4h`).
    - [x] هم‌راستا کردن `maxAge` کوکی‌ها در `app/api/auth/login/route.ts` با مدت جدید توکن.
  - [x] هندل صحیح خطای ۴۰۱ در پنل ادمین (`app/admin/page.tsx`):
    - [x] در توابع `fetchUsersList`، `fetchOrders` و سایر فراخوانی‌های `/api/admin/...` اگر `response.status === 401` بود:
      - [x] نمایش پیام «نشست شما منقضی شده؛ لطفاً مجدداً وارد شوید».
      - [x] ریدایرکت کاربر به `/login` (مثلاً با `window.location.href = '/login?expired=1'`).
    - [x] جلوگیری از خالی نمایش‌دادن جدول بدون توضیح (عدم نمایش حالت «لیست خالی» به‌عنوان خطا).

- [ ] **(اختیاری اما پیشنهادی) استفاده از Refresh Token برای تمدید خودکار نشست**
  - [x] ایجاد روت جدید `app/api/auth/refresh/route.ts`:
    - [x] خواندن `refreshToken` از کوکی.
    - [x] تأیید آن با `verifyRefreshToken`.
    - [x] تولید `accessToken` جدید و ست کردن آن در کوکی.
  - [x] اضافه‌کردن متد `refreshToken` در `useAuth` برای گرفتن access token جدید و به‌روزرسانی `localStorage`/state.
  - [x] طراحی و پیاده‌سازی منطق «تلاش مجدد خودکار» برای APIها:
    - [x] یک لایه‌ی مشترک fetch (یا هوک/utility) بسازیم که روی پاسخ `401` ابتدا `/api/auth/refresh` را صدا بزند.
    - [x] در صورت موفقیت در refresh، درخواست اصلی را یک‌بار دیگر با توکن جدید تکرار کند.
    - [x] اگر refresh ناموفق بود، کاربر را logout کند و به `/login?expired=1` منتقل کند.

- [x] **تست و بازبینی نهایی**
  - [x] سناریوهای واریز کاربر:
    - [x] کاربر درخواست واریز ثبت می‌کند و بلافاصله موجودی تغییر نمی‌کند.
    - [x] ادمین در لیست تراکنش‌ها، تراکنش را می‌بیند و با دکمه «تأیید» آن را تکمیل می‌کند؛ موجودی کاربر بعد از تأیید به‌درستی افزایش می‌یابد.
  - [x] سناریوهای رد واریز:
    - [x] تراکنش به وضعیت `FAILED` یا `CANCELLED` می‌رود و موجودی تغییری نمی‌کند.
  - [x] سناریوی طولانی‌مدت پنل ادمین:
    - [x] باز بودن پنل برای چند ساعت بدون پرش ناگهانی یا خالی‌شدن لیست‌ها.
    - [x] تست منقضی‌شدن توکن و تأیید این‌که کاربر پیام مناسب می‌بیند و به صفحه‌ی لاگین هدایت می‌شود (و در صورت پیاده‌سازی، Refresh Token عمل می‌کند).

- [x] **بازخورد @03 – دکمه نامرئی در دیالوگ تغییر وضعیت سفارش**
  - [x] شناسایی کامپوننت/بخش مربوط به دیالوگ «تایید تغییر وضعیت سفارش» در `app/admin/page.tsx`.
  - [x] بررسی کلاس‌ها و استایل‌های دکمه تایید (رنگ پس‌زمینه، رنگ متن، border و …) و علت نامرئی بودن آن.
  - [x] اعمال استایل و متن مناسب برای دکمه تایید، هماهنگ با دکمه «انصراف» (مثلاً `bg-gold` با متن «تایید و ادامه»).
  - [x] تست با همه‌ی حالت‌ها (تایید، عدم تایید، منقضی کردن) تا مطمئن شویم دکمه همیشه قابل‌مشاهده و قابل‌کلیک است.

- [x] **بازخورد @04 – تفکیک درست سکه‌ها از طلای وزنی در منطق و UI**
  - [x] بررسی منطق فعلی تکمیل سفارش در `app/api/admin/orders/status/route.ts` و محاسبه موجودی در `WalletBalance` برای محصولات سکه‌ای (`COIN_BAHAR_86`, `COIN_NIM_86`, `COIN_ROBE_86`).
  - [x] اصلاح منطق بک‌اند:
    - [x] برای سفارش‌های خرید سکه، از کیف پول ریالی مبلغ کسر شود و دیگر طلای وزنی اضافه نشود.
    - [x] برای فروش سکه، تعداد سکه از روی سفارش‌های تکمیل‌شده محاسبه و بدون دخالت کیف پول `GOLD` مبلغ ریالی به کیف پول ریالی اضافه شود.
  - [x] نمایش موجودی سکه‌ها در UI:
    - [x] در داشبورد/کیف‌پول (کامپوننت‌های `WalletSummary`, `Wallet`, یا بخش‌های مرتبط) بلوک جداگانه برای تعداد ربع/نیم/تمام سکه اضافه شود (واحد «عدد»).
    - [x] اطمینان از این‌که موجودی طلای وزنی (`GOLD_18K`, `GOLD_24K`) فقط بر حسب گرم نمایش داده می‌شود و شامل سکه‌ها نیست.
  - [x] اصلاح متن‌ها و واحدها:
    - [x] در دیالوگ تایید سفارش، برای سفارش‌های سکه‌ای متن به صورت «خرید X عدد ربع/نیم/تمام سکه ۸۶» و «افزایش تعداد سکه» نمایش داده شود، نه «X گرم طلا اضافه می‌شود».
    - [x] در لیست تراکنش‌ها، برای تراکنش‌های سکه‌ای واحد «عدد» نمایش داده شود و توضیح شامل نوع سکه باشد، نه فقط «۱ گرم».
  - [x] فعال‌سازی فروش سکه‌ها:
    - [x] در فرم فروش، برای محصول‌های سکه‌ای ورودی بر اساس تعداد سکه باشد و قبل از تایید، موجودی تعداد سکه کاربر چک شود.
    - [x] دکمه‌ها/آیکون‌های فروش سکه در UI بر اساس موجودی واقعی سکه فعال یا غیرفعال شوند (خاموش نبودن بی‌دلیل).

- [ ] **بازخورد @05 – فرمت‌کردن ورودی و نمایش مبالغ**
  - [x] ساخت یک utility/هوک برای فرمت لحظه‌ای ورودی‌های ریالی (استفاده از جداکننده هزارگان، جلوگیری از اعشار غیرضروری).
  - [x] جایگزینی ورودی‌های مهم (شارژ، برداشت، خرید/فروش، انتقال) با کامپوننت جدید تا کاربر هنگام تایپ عدد را با ویرگول ببیند.
  - [x] افزودن تابع `formatRial` برای نمایش موجودی‌ها بدون اعشار اما با جداکننده، و اعمال آن در تمام نمایش‌های ریالی (داشبورد، کیف‌پول، جدول تراکنش‌ها، PDF فاکتور، پیامک‌ها و سایر نمایش‌های ریالی پراکنده).

- [ ] **بازخورد @06 – قفل‌کردن عملیات هنگام شارژ/معامله و جلوگیری از سوءاستفاده**
  - [x] در UI کیف‌پول کاربر، تراکنش‌های `DEPOSIT` با وضعیت `PENDING` را به‌صورت جداگانه نمایش بده و تا قبل از تایید ادمین به موجودی اضافه نکن.
  - [x] بعد از ارسال سفارش خرید/فروش، یک دیالوگ/لایه‌ی فول‌اسکرین «در حال پردازش» با شمارنده معکوس (تا زمان `expiresAt`) ایجاد کن که سایر عملیات حساس کاربر (برداشت، سفارش جدید، انتقال و …) را تا مشخص شدن نتیجه قفل کند.
  - [x] در بک‌اند برداشت/انتقال/سفارش کاربر، اگر سفارش `PENDING` فعال دارد (BUY/SELL/DELIVERY/TRANSFER) درخواست جدید را با پیام مناسب رد کن تا نتواند در بازه‌ی انتظار موجودی را خارج کند.
  - [x] بعد از نهایی شدن سفارش (COMPLETED/FAILED/EXPIRED)، پیام واضح نتیجه‌ی معامله (با جزئیات مقدار و مبلغ) روی UI کاربر نمایش بده، دیالوگ «در حال پردازش» را ببند و قفل را بردار.

- [ ] **بازخورد @07 – تحویل فیزیکی و مدیریت درخواست‌ها**
  - [x] پیاده‌سازی/تکمیل روت‌های ادمین برای لیست‌کردن، فیلترکردن و به‌روزرسانی وضعیت `DeliveryRequest` (مقادیر `PENDING`، `APPROVED`، `READY`، `DELIVERED` و …).
  - [x] افزودن تب یا صفحه‌ای در پنل ادمین برای مشاهده و مدیریت درخواست‌های تحویل فیزیکی (به‌همراه اکشن‌های «تایید»، «آماده تحویل» و «تحویل شد» و نمایش جزئیات کاربر/محصول).
  - [x] نمایش لیست و وضعیت درخواست‌های تحویل فیزیکی در UI کاربر (مثلاً در کیف‌پول یا تب تاریخچه) تا کاربر ببیند درخواستش در چه مرحله‌ای است و آیا تحویل شده است یا خیر.
  - [x] اطمینان از این‌که فرم `PhysicalDelivery` در فرانت، در صورت موفقیت و خطا پیام مناسب نمایش می‌دهد و به روت‌های جدید متصل است (رفع حالت «درخواست شما ثبت شد اما جایی دیده نمی‌شود»).

- [ ] **بازخورد @08 – الگوی قفل کامل معاملات (الهام از یزدان‌طلا)**
  - [x] بعد از ثبت موفق سفارش خرید/فروش، دیالوگ «درخواست شما ارسال شد، لطفاً منتظر بمانید» به‌صورت فول‌اسکرین و غیرقابل‌بستن (تا زمان پاسخ یا انقضا) نمایش بده و اجازه‌ی خروج/انجام عملیات دیگر را محدود کن.
  - [x] این دیالوگ را با وضعیت واقعی سفارش (COMPLETED/FAILED/EXPIRED) همگام کن؛ مثلاً با polling یا نوتیفیکیشن، و در لحظه‌ی تغییر وضعیت، آن را به پیام نتیجه‌ی نهایی تبدیل کن.
  - [x] پس از نمایش نتیجه‌ی سفارش (موفق همراه با جزئیات مقدار/قیمت، یا رد/منقضی با دلیل)، دیالوگ را ببند و محدودیت‌های اعمال‌شده روی UI کاربر را بردار.


